---
// MermaidInit â€” client-side Mermaid rendering with dual selectors.
// Include in any layout that should support Mermaid diagrams.
// Pages without mermaid code blocks incur zero JS overhead.
---

<script is:inline>
  async function initMermaid() {
    // Dual selectors: Shiki output + standard markdown convention
    const preBlocks = document.querySelectorAll(
      'pre[data-language="mermaid"], pre:has(> code.language-mermaid)'
    );
    if (preBlocks.length === 0) return;

    try {
      // Pinned CDN version
      const { default: mermaid } = await import(
        "https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs"
      );

      mermaid.initialize({
        startOnLoad: false,
        securityLevel: "strict",
        theme: "neutral",
      });

      for (var i = 0; i < preBlocks.length; i++) {
        var preEl = preBlocks[i];

        // Duplicate guard: skip if already rendered (view transitions safety)
        if (
          preEl.nextElementSibling &&
          preEl.nextElementSibling.classList.contains("mermaid-rendered")
        )
          continue;

        var codeEl = preEl.querySelector("code");
        var source = codeEl ? codeEl.textContent || "" : "";
        var uniqueId = "mermaid-diagram-" + Date.now() + "-" + i;

        try {
          var result = await mermaid.render(uniqueId, source);
          var rendered = document.createElement("div");
          rendered.classList.add("mermaid-rendered");
          rendered.innerHTML = result.svg;
          // Non-destructive: insert rendered SVG after, then hide original
          preEl.insertAdjacentElement("afterend", rendered);
          preEl.classList.add("mermaid-source-hidden");
        } catch (err) {
          // On failure: leave the <pre> visible so users see the raw source
          console.warn("Mermaid render failed for block " + i + ":", err);
        }
      }
    } catch (err) {
      // CDN unreachable: raw code blocks remain visible
      console.warn("Failed to load Mermaid library:", err);
    }
  }

  // Run on initial load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMermaid);
  } else {
    initMermaid();
  }

  // Re-run after view transitions
  document.addEventListener("astro:after-swap", initMermaid);
</script>
