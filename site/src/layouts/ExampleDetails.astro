---
import { render, type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Tag from "@/components/Tag.astro";
import BackButton from "@/components/BackButton.astro";
import BackToTopButton from "@/components/BackToTopButton.astro";
import MermaidInit from "@/components/MermaidInit.astro";
import { postUrl } from "@/utils/postUrl";
import { slugifyStr } from "@/utils/slugify";
import IconGitHub from "@/assets/icons/IconGitHub.svg";
import { SITE } from "@/config";

type Props = {
  example: CollectionEntry<"examples">;
};

const { example } = Astro.props;

const { title, description, tags, repoPath, githubUrl, postSlugs } =
  example.data;

const { Content } = await render(example);

const githubLink =
  githubUrl ??
  `https://github.com/tomazfernandes/tomazfernandes-dev/tree/main/${repoPath}`;

// Resolve related posts
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const relatedPosts = (postSlugs ?? [])
  .map(ps => allPosts.find(p => p.data.slug === ps))
  .filter(Boolean) as CollectionEntry<"blog">[];

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  description,
};
---

<Layout {...layoutProps}>
  <Header />
  <BackButton />
  <main
    id="main-content"
    class:list={["app-layout pb-12", { "mt-8": !SITE.showBackButton }]}
  >
    <h1 class="inline-block text-2xl font-bold text-accent sm:text-3xl">
      {title}
    </h1>
    <p class="mt-2 italic opacity-80">{description}</p>

    <article
      id="article"
      class="app-prose mt-8 w-full max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)"
    >
      <Content />
    </article>

    <!-- Run it box -->
    <div class="my-8 rounded border border-border bg-muted/25 p-4">
      <h2 class="mb-3 text-xl font-semibold">Run it</h2>
      <div class="flex items-center gap-2">
        <IconGitHub class="inline-block size-5" />
        <a
          href={githubLink}
          target="_blank"
          rel="noopener noreferrer"
          class="text-accent decoration-dashed underline-offset-4 hover:underline"
        >
          View on GitHub
        </a>
      </div>
      <div class="mt-3 space-y-2">
        <code class="block rounded bg-muted/75 p-3 text-sm">
          git clone https://github.com/tomazfernandes/tomazfernandes-dev.git &&
          cd tomazfernandes-dev/{repoPath}
        </code>
        <code class="block rounded bg-muted/75 p-3 text-sm">
          make run-assembly
          <span class="opacity-60"># container registry view at startup</span>
        </code>
        <code class="block rounded bg-muted/75 p-3 text-sm">
          make run-interceptor
          <span class="opacity-60"># before/after interceptor hooks</span>
        </code>
        <code class="block rounded bg-muted/75 p-3 text-sm">
          make run-error-handler
          <span class="opacity-60"># error handling and redelivery</span>
        </code>
        <code class="block rounded bg-muted/75 p-3 text-sm">
          make run-ack-callback
          <span class="opacity-60"># delete confirmation logs</span>
        </code>
        <code class="block rounded bg-muted/75 p-3 text-sm">
          make run-all
          <span class="opacity-60"># all scenarios â€” Docker only, no Java required</span>
        </code>
      </div>
    </div>

    <hr class="my-8 border-dashed" />

    {
      tags.length > 0 && (
        <ul class="mt-4 mb-8 flex flex-wrap gap-4 sm:my-8">
          {tags.map(tag => (
            <Tag tag={slugifyStr(tag)} tagName={tag} size="sm" />
          ))}
        </ul>
      )
    }

    {
      relatedPosts.length > 0 && (
        <>
          <h2 class="text-xl font-semibold">Related Posts</h2>
          <ul class="mt-2 mb-8">
            {relatedPosts.map(post => (
              <li class="my-2">
                <a
                  href={postUrl(post)}
                  class="text-accent decoration-dashed underline-offset-4 hover:underline"
                >
                  {post.data.title}
                </a>
              </li>
            ))}
          </ul>
        </>
      )
    }

    <BackToTopButton />
  </main>
  <Footer />
  <MermaidInit />
</Layout>
